<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise E-Commerce Intelligence | SIG Nasional</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #1e293b; overflow-x: hidden; }

        #welcome-page {
            height: 100vh; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), 
                        url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; color: white; position: fixed; z-index: 10000; transition: 1s ease;
        }

        .navbar-custom { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; padding: 0.8rem 0; }
        .nav-link-custom { border: none; background: transparent; font-weight: 600; color: #64748b; padding: 10px 18px; border-radius: 8px; transition: 0.3s; display: flex; align-items: center; }
        .nav-link-custom.active { background: #eff6ff; color: var(--accent); }

        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 100%; }
        .metric-label { font-size: 0.7rem; font-weight: 700; color: #64748b; letter-spacing: 0.1em; }
        
        #map { height: 550px; border-radius: 15px; border: 1px solid #e2e8f0; }
        
        /* Legenda yang lebih jelas */
        .legend { background: white; padding: 15px; border-radius: 12px; font-size: 0.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15); line-height: 1.6; border: 1px solid #ddd; }
        .legend i { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2); }
        
        footer { background: #0f172a; color: #94a3b8; padding: 60px 0; margin-top: 80px; }
        .badge-dev { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 8px 16px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="welcome-page">
    <div class="text-center animate__animated animate__fadeIn">
        <h1 class="display-3 fw-bold mb-2 text-white">Enterprise Intelligence</h1>
        <p class="lead opacity-75 mb-5 px-3">Sistem Informasi Geografis Penjualan E-Commerce Nasional</p>
        <button class="btn btn-primary btn-lg rounded-pill px-5 fw-bold shadow-lg" onclick="launchApp()">
            Buka Dashboard <i class="bi bi-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <nav class="navbar-custom">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="fw-bold fs-4">SIG<span class="text-primary">ECOM</span></span>
            <div class="d-flex gap-2">
                <button class="nav-link-custom active" onclick="switchTab('peta', this)"><i class="bi bi-geo-alt-fill me-2"></i> Peta</button>
                <button class="nav-link-custom" onclick="switchTab('statistik', this)"><i class="bi bi-bar-chart-fill me-2"></i> Statistik</button>
                <button class="nav-link-custom" onclick="switchTab('potensi', this)"><i class="bi bi-rocket-takeoff-fill me-2"></i> Potensi</button>
                <button class="nav-link-custom" onclick="switchTab('info', this)"><i class="bi bi-info-circle-fill me-2"></i> Info</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="glass-card mb-4 border-start border-4 border-primary">
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <label class="metric-label d-block mb-1">FILTER WILAYAH (PROVINSI)</label>
                    <select id="filterProvinsi" class="form-select border-0 bg-light shadow-sm" onchange="filterData()">
                        <option value="all">Seluruh Indonesia</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="metric-label d-block mb-1">CARI KABUPATEN / KOTA</label>
                    <div class="input-group bg-light rounded shadow-sm">
                        <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchCity" class="form-control border-0 bg-transparent" placeholder="Ketik nama wilayah..." onkeyup="searchLocation()">
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-outline-primary rounded-pill btn-sm px-4 fw-bold" onclick="exportToCSV()">
                        <i class="bi bi-file-earmark-arrow-down-fill me-2"></i> Unduh CSV
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4 text-center">
            <div class="col-md-4"><div class="glass-card"><p class="metric-label mb-1">TOTAL VALUASI</p><h3 id="m1" class="fw-bold m-0">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="glass-card text-primary"><p class="metric-label text-primary mb-1">RATA-RATA WILAYAH</p><h3 id="m2" class="fw-bold m-0">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="glass-card"><p class="metric-label mb-1">JUMLAH TITIK DATA</p><h3 id="m3" class="fw-bold m-0">0</h3></div></div>
        </div>

        <div id="tab-peta" class="content-section">
            <div id="map"></div>
        </div>

        <div id="tab-statistik" class="content-section d-none">
            <div class="glass-card">
                <h5 class="fw-bold mb-4">Grafik Distribusi Nasional</h5>
                <div style="height: 450px;"><canvas id="mainChart"></canvas></div>
                <div class="mt-4 p-3 bg-light rounded text-muted small border-start border-4 border-primary">
                    <i class="bi bi-database-fill me-2"></i><strong>Sumber Data:</strong> Dataset Kaggle (<em>ecommerce_kabkota_centroid.csv</em>).
                </div>
            </div>
        </div>

        <div id="tab-potensi" class="content-section d-none">
            <div class="row g-4">
                <div class="col-md-6"><div class="glass-card h-100"><h5 class="fw-bold mb-3 text-primary">Top 10 Provinsi</h5><div id="table-p"></div></div></div>
                <div class="col-md-6"><div class="glass-card h-100"><h5 class="fw-bold mb-3 text-success">Top 10 Kab/Kota</h5><div id="table-k"></div></div></div>
            </div>
        </div>

        <div id="tab-info" class="content-section d-none">
            <div class="glass-card">
                <h4 class="fw-bold mb-4">Tentang Proyek</h4>
                <p>Website ini dikembangkan untuk memberikan pemahaman spasial mengenai ekonomi digital di Indonesia. Dengan menggabungkan data transaksi dan koordinat geografis, sistem ini mampu mengidentifikasi titik-titik pertumbuhan ekonomi di berbagai wilayah Indonesia.</p>
                <hr class="my-4">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6 class="fw-bold text-primary mb-3">DATASET & METODOLOGI</h6>
                        <p class="small text-muted">Dataset utama berasal dari platform Kaggle, diproses menjadi data centroid penjualan e-commerce untuk pemetaan dan statistik.</p>
                    </div>
                    <div class="col-md-6 ps-md-4">
                        <h6 class="fw-bold text-primary mb-3">VISUALISASI STRATEGIS</h6>
                        <p class="small text-muted">Menggunakan skala logaritmik dan gradasi warna kontras untuk kenyamanan visual di tengah perbedaan nilai transaksi yang sangat tajam.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p class="text-uppercase small fw-bold mb-4" style="letter-spacing: 3px; color: #64748b;">Pengembang</p>
            <div class="d-flex flex-wrap justify-content-center gap-3">
                <div class="badge-dev">Rizki Chandra</div>
                <div class="badge-dev">Muhammad Damar Wyasa Seta</div>
                <div class="badge-dev">Rizal Fauzan Rosyadi</div>
            </div>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let map, markers = [], fullData = [], chartInstance;

    function launchApp() {
        document.getElementById('welcome-page').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            initMap();
            loadData();
        }, 800);
    }

    // FUNGSI GRADASI WARNA YANG LEBIH KONTRAS
    function getMarkerColor(v) {
        return v > 10000000 ? '#081d58' : // Biru Sangat Gelap (Top)
               v > 5000000  ? '#225ea8' : // Biru Tua
               v > 1000000  ? '#41b6c4' : // Toska/Cyan
               v > 500000   ? '#a1dab4' : // Hijau Muda
                              '#ffffcc' ; // Kuning Sangat Muda (Low)
    }

    function initMap() {
        map = L.map('map', {zoomControl: false}).setView([-2.5, 118], 5);
        L.control.zoom({position: 'topright'}).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
            var div = L.DomUtil.create('div', 'legend');
            var grades = [0, 500000, 1000000, 5000000, 10000000];
            var labels = ['<strong>Skala Valuasi</strong>'];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML += labels.push(
                    '<i style="background:' + getMarkerColor(grades[i] + 1) + '"></i> ' +
                    (grades[i]/1e6) + ' Jt' + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/1e6) + ' Jt' : '+')
                );
            }
            div.innerHTML = labels.join('<br>');
            return div;
        };
        legend.addTo(map);
    }

    function loadData() {
        Papa.parse("ecommerce_kabkota_centroid.csv", {
            download: true, header: true,
            complete: function(res) {
                fullData = res.data.filter(r => r.total_pembayaran && r.lat);
                const provs = [...new Set(fullData.map(d => d.PROVINSI))].sort();
                const select = document.getElementById('filterProvinsi');
                provs.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
                updateView(fullData);
            }
        });
    }

    function updateView(data) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let totalVal = 0, provStats = {};

        data.forEach(row => {
            const v = parseFloat(row.total_pembayaran);
            totalVal += v;
            provStats[row.PROVINSI] = (provStats[row.PROVINSI] || 0) + v;

            const marker = L.circleMarker([row.lat, row.lon], {
                radius: Math.log(v + 1) * 0.8,
                fillColor: getMarkerColor(v),
                color: "#222", weight: 0.5, fillOpacity: 0.85
            }).bindPopup(`<strong>${row.KAB_KOTA}</strong><br>Valuasi: Rp ${v.toLocaleString('id-ID')}`);
            
            marker.addTo(map);
            markers.push(marker);
        });

        document.getElementById('m1').innerText = 'Rp ' + (totalVal/1e6).toFixed(1) + ' Jt';
        document.getElementById('m2').innerText = 'Rp ' + (totalVal/data.length/1e6).toFixed(2) + ' Jt';
        document.getElementById('m3').innerText = data.length + ' Wilayah';

        updateCharts(provStats);
        updateTables(data, provStats);
    }

    function filterData() {
        const val = document.getElementById('filterProvinsi').value;
        const filtered = val === 'all' ? fullData : fullData.filter(d => d.PROVINSI === val);
        updateView(filtered);
        if(val !== 'all' && filtered.length > 0) {
            const bounds = L.latLngBounds(filtered.map(d => [d.lat, d.lon]));
            map.fitBounds(bounds, {padding: [50, 50]});
        }
    }

    function searchLocation() {
        const query = document.getElementById('searchCity').value.toLowerCase();
        if(query.length > 3) {
            const found = fullData.find(d => d.KAB_KOTA.toLowerCase().includes(query));
            if(found) map.setView([found.lat, found.lon], 10);
        }
    }

    function exportToCSV() {
        const csv = Papa.unparse(fullData);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'SIGECOM_Export.csv'; a.click();
    }

    function updateCharts(stats) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const labels = Object.keys(stats).sort((a,b) => stats[b] - stats[a]).slice(0, 10);
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Valuasi', data: labels.map(l => stats[l]), backgroundColor: '#2563eb', borderRadius: 8 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function updateTables(data, provStats) {
        const topP = Object.entries(provStats).sort((a,b) => b[1] - a[1]).slice(0, 10);
        let h1 = '<table class="table table-sm"><tbody>';
        topP.forEach(p => h1 += `<tr><td>${p[0]}</td><td class="fw-bold text-end">Rp ${(p[1]/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('table-p').innerHTML = h1 + '</tbody></table>';

        const topK = [...data].sort((a,b) => b.total_pembayaran - a.total_pembayaran).slice(0, 10);
        let h2 = '<table class="table table-sm"><tbody>';
        topK.forEach(k => h2 += `<tr><td>${k.KAB_KOTA}</td><td class="fw-bold text-primary text-end">Rp ${(parseFloat(k.total_pembayaran)/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('table-k').innerHTML = h2 + '</tbody></table>';
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('d-none'));
        document.querySelectorAll('.nav-link-custom').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.remove('d-none');
        btn.classList.add('active');
        if(tabId === 'peta') map.invalidateSize();
    }
</script>
</body>
</html>
