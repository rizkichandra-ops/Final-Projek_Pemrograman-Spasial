<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise E-Commerce Analytics</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.9);
            --border: #e2e8f0;
            --accent: #0f172a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            color: #1e293b;
            letter-spacing: -0.01em;
        }

        /* --- Welcome Page (Glassmorphism) --- */
        #welcome-page {
            height: 100vh; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            background: radial-gradient(circle at top right, #3b82f6, #1e3a8a);
            color: white; position: fixed; z-index: 10000; transition: all 1s ease;
        }

        .welcome-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem; border-radius: 2rem; border: 1px solid rgba(255,255,255,0.2);
            text-align: center; max-width: 600px;
        }

        /* --- Dashboard Header --- */
        .dashboard-nav {
            background: var(--glass); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 0; position: sticky; top: 0; z-index: 1000;
        }

        /* --- Metric Cards --- */
        .card-metric {
            background: white; border: 1px solid var(--border);
            border-radius: 1.25rem; padding: 1.5rem; transition: all 0.3s ease;
        }
        .card-metric:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); }

        /* --- Map Styling --- */
        #map { 
            height: 650px; border-radius: 1.5rem; 
            border: 1px solid var(--border); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }

        /* --- Floating Legend --- */
        .legend { 
            background: var(--glass); backdrop-filter: blur(8px);
            padding: 1.25rem; border-radius: 1rem; border: 1px solid var(--border);
            font-size: 0.8rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .legend i { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }

        /* --- Table Styling --- */
        .table-custom { font-size: 0.9rem; }
        .table-custom thead th { 
            background: #f8fafc; color: #64748b; font-weight: 600; 
            text-transform: uppercase; font-size: 0.75rem; border: none;
        }

        .tab-btn {
            border: none; background: transparent; color: #64748b;
            font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem;
        }
        .tab-btn.active { background: #f1f5f9; color: #0f172a; }

        footer { background: white; padding: 3rem 0; border-top: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="welcome-page">
    <div class="welcome-card animate__animated animate__zoomIn">
        <span class="badge bg-info mb-3">v2.0 Enterprise</span>
        <h1 class="fw-bold mb-3 display-4">SIG E-Commerce</h1>
        <p class="opacity-75 mb-4">Pemetaan analitis cerdas untuk optimalisasi keputusan bisnis nasional Indonesia.</p>
        <button class="btn btn-light btn-lg rounded-pill px-5 fw-bold" onclick="launchApp()">Mulai Analisis</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <nav class="dashboard-nav">
        <div class="container d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold">SIG<span class="text-primary">ECOM</span></h5>
            <div class="d-flex gap-2">
                <button class="tab-btn active" onclick="switchPage('peta', this)">Peta</button>
                <button class="tab-btn" onclick="switchPage('statistik', this)">Statistik</button>
                <button class="tab-btn" onclick="switchPage('potensi', this)">Wilayah Potensial</button>
            </div>
        </div>
    </nav>

    <div class="container py-4 animate__animated animate__fadeIn">
        <div class="row g-4 mb-4 text-center">
            <div class="col-md-4">
                <div class="card-metric">
                    <p class="text-muted small fw-bold mb-1 uppercase">VALUASI TRANSAKSI</p>
                    <h2 id="total-val" class="fw-bold m-0">Rp 0M</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-metric">
                    <p class="text-muted small fw-bold mb-1 uppercase">RATA-RATA PER WILAYAH</p>
                    <h2 id="avg-val" class="fw-bold m-0 text-primary">Rp 0M</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-metric">
                    <p class="text-muted small fw-bold mb-1 uppercase">TITIK CAKUPAN</p>
                    <h2 id="total-points" class="fw-bold m-0">0</h2>
                </div>
            </div>
        </div>

        <div id="page-peta" class="content-page">
            <div id="map"></div>
        </div>

        <div id="page-statistik" class="content-page d-none">
            <div class="card-metric">
                <h5 class="fw-bold mb-4">Distribusi Penjualan Per Provinsi</h5>
                <div style="height: 450px;"><canvas id="chartSales"></canvas></div>
            </div>
        </div>

        <div id="page-potensi" class="content-page d-none">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card-metric">
                        <h6 class="fw-bold mb-3">Top 5 Provinsi Strategis</h6>
                        <div id="list-prov"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-metric">
                        <h6 class="fw-bold mb-3">Top 5 Kab/Kota Potensial</h6>
                        <div id="list-kab"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <h6 class="fw-bold mb-1">Tim Pengembangan Proyek</h6>
                    <p class="text-muted small m-0">Rizki Chandra &bull; Damar Wyasa Seta &bull; Rizal Fauzan Rosyadi</p>
                </div>
                <div class="col-md-6 text-center text-md-end mt-3 mt-md-0">
                    <p class="text-muted small m-0">&copy; 2025 Enterprise Intelligence System. Build v2.0</p>
                </div>
            </div>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function launchApp() {
        document.getElementById('welcome-page').style.opacity = '0';
        document.getElementById('welcome-page').style.transform = 'translateY(-20px)';
        setTimeout(() => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            map.invalidateSize();
        }, 1000);
    }

    function switchPage(page, btn) {
        document.querySelectorAll('.content-page').forEach(p => p.classList.add('d-none'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-' + page).classList.remove('d-none');
        btn.classList.add('active');
        if(page === 'peta') map.invalidateSize();
    }

    // MAP INITIALIZATION
    var map = L.map('map', {zoomControl: false}).setView([-2.5, 118], 5);
    L.control.zoom({position: 'topright'}).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    function getBubbleColor(d) {
        return d > 10000000 ? '#1e3a8a' : d > 5000000 ? '#2563eb' : d > 1000000 ? '#60a5fa' : '#bfdbfe';
    }

    let provData = {}, rawCsv = [];

    Papa.parse("ecommerce_kabkota_centroid.csv", {
        download: true, header: true,
        complete: function(res) {
            let totalVal = 0;
            rawCsv = res.data.filter(r => r.total_pembayaran);
            
            rawCsv.forEach(row => {
                const val = parseFloat(row.total_pembayaran);
                const prov = row.PROVINSI;
                totalVal += val;
                provData[prov] = (provData[prov] || 0) + val;

                L.circleMarker([row.lat, row.lon], {
                    radius: Math.sqrt(val) * 0.007 + 3,
                    fillColor: getBubbleColor(val), color: "#fff", weight: 1, fillOpacity: 0.8
                }).bindPopup(`<div style="font-size:12px;"><strong>${row.KAB_KOTA}</strong><br>Valuasi: Rp ${val.toLocaleString('id-ID')}</div>`).addTo(map);
            });

            // Populate Metrics
            document.getElementById('total-val').innerText = 'Rp ' + (totalVal/1e6).toFixed(1) + ' Jt';
            document.getElementById('avg-val').innerText = 'Rp ' + (totalVal/rawCsv.length/1e6).toFixed(2) + ' Jt';
            document.getElementById('total-points').innerText = rawCsv.length;

            renderStatistics();
            renderTopWilayah();
        }
    });

    // CUSTOM LEGEND
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        var div = L.DomUtil.create('div', 'legend'), 
            grades = [0, 1000000, 5000000, 10000000],
            labels = ['<strong class="mb-2 d-block">Skala Valuasi</strong>'];
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += labels.push('<i style="background:' + getBubbleColor(grades[i] + 1) + '"></i> ' + (grades[i]/1e6) + ' Jt' + (grades[i+1] ? '&ndash;' + (grades[i+1]/1e6) + ' Jt' : '+'));
        }
        div.innerHTML = labels.join('<br>');
        return div;
    };
    legend.addTo(map);

    function renderStatistics() {
        const labels = Object.keys(provData).sort((a,b) => provData[b] - provData[a]).slice(0, 10);
        new Chart(document.getElementById('chartSales'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ 
                    label: 'Valuasi (IDR)', 
                    data: labels.map(l => provData[l]), 
                    backgroundColor: '#3b82f6', borderRadius: 8 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTopWilayah() {
        // Table Provinsi
        const topProv = Object.entries(provData).sort((a,b) => b[1] - a[1]).slice(0, 5);
        let h1 = '<table class="table table-custom table-borderless"><thead><tr><th>Wilayah</th><th>Status</th></tr></thead><tbody>';
        topProv.forEach(p => h1 += `<tr><td>${p[0]}</td><td class="fw-bold text-primary">Rp ${(p[1]/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('list-prov').innerHTML = h1 + '</tbody></table>';

        // Table Kota
        const topKab = rawCsv.sort((a,b) => b.total_pembayaran - a.total_pembayaran).slice(0, 5);
        let h2 = '<table class="table table-custom table-borderless"><thead><tr><th>Kab/Kota</th><th>Valuasi</th></tr></thead><tbody>';
        topKab.forEach(k => h2 += `<tr><td>${k.KAB_KOTA}</td><td class="fw-bold text-success">Rp ${(k.total_pembayaran/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('list-kab').innerHTML = h2 + '</tbody></table>';
    }
</script>
</body>
</html>
