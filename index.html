<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise E-Commerce Intelligence</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #1e293b; }

        #welcome-page {
            height: 100vh; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            background: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), 
                        url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; color: white; position: fixed; z-index: 10000; transition: 1s ease;
        }

        .navbar-custom { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; padding: 0.8rem 0; }
        .nav-link-custom { border: none; background: transparent; font-weight: 600; color: #64748b; padding: 8px 16px; border-radius: 8px; transition: 0.3s; }
        .nav-link-custom.active { background: #eff6ff; color: var(--accent); }

        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        #map { height: 550px; border-radius: 15px; border: 1px solid #e2e8f0; }
        
        .search-box { position: absolute; top: 10px; left: 50px; z-index: 1000; width: 250px; }
        .legend { background: white; padding: 12px; border-radius: 10px; font-size: 0.75rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .legend i { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        
        footer { background: #0f172a; color: #94a3b8; padding: 60px 0; margin-top: 80px; }
    </style>
</head>
<body>

<div id="welcome-page">
    <div class="text-center animate__animated animate__fadeIn">
        <h1 class="display-3 fw-bold mb-3">Enterprise Intelligence</h1>
        <p class="lead opacity-75 mb-5 px-3">Visualisasi Data & Analisis Spasial E-Commerce Nasional</p>
        <button class="btn btn-primary btn-lg rounded-pill px-5 fw-bold" onclick="launchApp()">Buka Dashboard</button>
    </div>
</div>

<div id="main-content" style="display:none;">
    <nav class="navbar-custom">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="fw-bold fs-4">SIG<span class="text-primary">ECOM</span></span>
            <div class="d-flex gap-2">
                <button class="nav-link-custom active" onclick="switchTab('peta', this)">üìç Peta</button>
                <button class="nav-link-custom" onclick="switchTab('statistik', this)">üìä Statistik</button>
                <button class="nav-link-custom" onclick="switchTab('potensi', this)">üöÄ Potensi</button>
                <button class="nav-link-custom" onclick="switchTab('info', this)">‚ÑπÔ∏è Info</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="glass-card mb-4">
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Filter Wilayah</label>
                    <select id="filterProvinsi" class="form-select border-0 bg-light" onchange="filterData()">
                        <option value="all">Seluruh Indonesia</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Cari Kota/Kabupaten</label>
                    <input type="text" id="searchCity" class="form-control border-0 bg-light" placeholder="Ketik nama kota..." onkeyup="searchLocation()">
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-outline-primary rounded-pill btn-sm mt-3" onclick="exportToCSV()">‚¨áÔ∏è Ekspor Data (.csv)</button>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4 text-center">
            <div class="col-md-4"><div class="glass-card"><p class="small text-muted fw-bold mb-1">TOTAL VALUASI</p><h3 id="m1" class="fw-bold m-0">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="glass-card"><p class="small text-muted fw-bold mb-1">RATA-RATA</p><h3 id="m2" class="fw-bold m-0 text-primary">Rp 0</h3></div></div>
            <div class="col-md-4"><div class="glass-card"><p class="small text-muted fw-bold mb-1">TITIK DATA</p><h3 id="m3" class="fw-bold m-0">0</h3></div></div>
        </div>

        <div id="tab-peta" class="content-section position-relative">
            <div id="map"></div>
        </div>

        <div id="tab-statistik" class="content-section d-none">
            <div class="glass-card">
                <h5 class="fw-bold mb-4">Grafik Distribusi Penjualan</h5>
                <div style="height: 450px;"><canvas id="mainChart"></canvas></div>
            </div>
        </div>

        <div id="tab-potensi" class="content-section d-none">
            <div class="row g-4">
                <div class="col-md-6"><div class="glass-card"><h5 class="fw-bold mb-3">Top 10 Provinsi</h5><div id="table-p"></div></div></div>
                <div class="col-md-6"><div class="glass-card"><h5 class="fw-bold mb-3">Top 10 Kota/Kab</h5><div id="table-k"></div></div></div>
            </div>
        </div>

        <div id="tab-info" class="content-section d-none">
            <div class="glass-card">
                <h4 class="fw-bold">Tentang Proyek</h4>
                <p>Website ini dikembangkan untuk memberikan pemahaman spasial mengenai ekonomi digital nasional. Menggunakan dataset <em>ecommerce_kabkota_centroid.csv</em>.</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p class="text-uppercase small fw-bold mb-4" style="letter-spacing: 3px; color: #64748b;">Pengembang</p>
            <div class="row g-3 justify-content-center">
                <div class="col-auto"><span class="badge bg-secondary px-3 py-2">Rizki Chandra</span></div>
                <div class="col-auto"><span class="badge bg-secondary px-3 py-2">Damar Wyasa Seta</span></div>
                <div class="col-auto"><span class="badge bg-secondary px-3 py-2">Rizal Fauzan Rosyadi</span></div>
            </div>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let map, markers = [], fullData = [], chartInstance;

    function launchApp() {
        document.getElementById('welcome-page').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            initMap();
            loadData();
        }, 800);
    }

    function initMap() {
        map = L.map('map', {zoomControl: false}).setView([-2.5, 118], 5);
        L.control.zoom({position: 'topright'}).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    }

    function loadData() {
        Papa.parse("ecommerce_kabkota_centroid.csv", {
            download: true, header: true,
            complete: function(res) {
                fullData = res.data.filter(r => r.total_pembayaran && r.lat);
                
                // Isi Dropdown Provinsi
                const provs = [...new Set(fullData.map(d => d.PROVINSI))].sort();
                const select = document.getElementById('filterProvinsi');
                provs.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
                
                updateView(fullData);
            }
        });
    }

    function updateView(data) {
        // Hapus marker lama
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        let totalVal = 0;
        let provStats = {};

        data.forEach(row => {
            const v = parseFloat(row.total_pembayaran);
            totalVal += v;
            provStats[row.PROVINSI] = (provStats[row.PROVINSI] || 0) + v;

            const marker = L.circleMarker([row.lat, row.lon], {
                radius: Math.log(v + 1) * 0.7,
                fillColor: v > 5000000 ? '#1e3a8a' : '#60a5fa',
                color: "white", weight: 0.5, fillOpacity: 0.8
            }).bindPopup(`<strong>${row.KAB_KOTA}</strong><br>Rp ${v.toLocaleString('id-ID')}`);
            
            marker.addTo(map);
            markers.push(marker);
        });

        document.getElementById('m1').innerText = 'Rp ' + (totalVal/1e6).toFixed(1) + ' Jt';
        document.getElementById('m2').innerText = 'Rp ' + (totalVal/data.length/1e6).toFixed(2) + ' Jt';
        document.getElementById('m3').innerText = data.length;

        updateCharts(provStats);
        updateTables(data, provStats);
    }

    function filterData() {
        const val = document.getElementById('filterProvinsi').value;
        const filtered = val === 'all' ? fullData : fullData.filter(d => d.PROVINSI === val);
        updateView(filtered);
        if(val !== 'all') {
            const bounds = L.latLngBounds(filtered.map(d => [d.lat, d.lon]));
            map.fitBounds(bounds);
        }
    }

    function searchLocation() {
        const query = document.getElementById('searchCity').value.toLowerCase();
        const found = fullData.find(d => d.KAB_KOTA.toLowerCase().includes(query));
        if(found && query.length > 3) {
            map.setView([found.lat, found.lon], 10);
        }
    }

    function exportToCSV() {
        const csv = Papa.unparse(fullData);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Laporan_Ecommerce.csv';
        a.click();
    }

    function updateCharts(stats) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const labels = Object.keys(stats).sort((a,b) => stats[b] - stats[a]).slice(0, 10);
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Valuasi', data: labels.map(l => stats[l]), backgroundColor: '#2563eb' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function updateTables(data, provStats) {
        const topP = Object.entries(provStats).sort((a,b) => b[1] - a[1]).slice(0, 10);
        let h1 = '<table class="table table-sm"><tbody>';
        topP.forEach(p => h1 += `<tr><td>${p[0]}</td><td class="fw-bold">Rp ${(p[1]/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('table-p').innerHTML = h1 + '</tbody></table>';

        const topK = [...data].sort((a,b) => b.total_pembayaran - a.total_pembayaran).slice(0, 10);
        let h2 = '<table class="table table-sm"><tbody>';
        topK.forEach(k => h2 += `<tr><td>${k.KAB_KOTA}</td><td class="fw-bold text-primary">Rp ${(parseFloat(k.total_pembayaran)/1e6).toFixed(1)} Jt</td></tr>`);
        document.getElementById('table-k').innerHTML = h2 + '</tbody></table>';
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('d-none'));
        document.querySelectorAll('.nav-link-custom').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.remove('d-none');
        btn.classList.add('active');
        if(tabId === 'peta') map.invalidateSize();
    }
</script>
</body>
</html>
