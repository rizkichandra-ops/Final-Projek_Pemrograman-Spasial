<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Intelligence Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --secondary: #64748b; --success: #22c55e; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: var(--dark); overflow-x: hidden; }
        
        /* 1. Landing Page */
        #welcome-page {
            height: 100vh; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white; position: fixed; z-index: 10000; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hero-title { font-size: 3.5rem; font-weight: 700; letter-spacing: -1px; }
        .btn-glow {
            background: var(--primary); color: white; border: none; padding: 16px 48px;
            border-radius: 50px; font-weight: 600; transition: 0.3s; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }
        .btn-glow:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(37, 99, 235, 0.6); color: white; }

        /* 2. Main Layout */
        #main-content { display: none; opacity: 0; transition: opacity 1s; }
        .navbar { background: white; border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .nav-pills .nav-link { color: var(--secondary); font-weight: 500; border-radius: 8px; margin: 0 5px; cursor: pointer; }
        .nav-pills .nav-link.active { background-color: var(--primary); color: white; }

        /* 3. Dashboard Cards */
        .stat-card { background: white; border: none; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: 0.3s; height: 100%; }
        .icon-box { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 24px; }

        /* 4. Map & Legend */
        #map { height: 600px; width: 100%; border-radius: 16px; z-index: 1; }
        .legend { 
            background: white; padding: 15px; line-height: 24px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-size: 13px; font-weight: 500;
        }
        .legend i { width: 12px; height: 12px; float: left; margin: 6px 10px 0 0; border-radius: 50%; opacity: 0.8; }

        /* 5. Footer */
        footer { background: white; border-top: 1px solid #e2e8f0; padding: 40px 0; margin-top: 60px; }
        
        .tab-page { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="welcome-page">
    <div class="text-center px-4">
        <h1 class="hero-title mb-3">Geo-Intelligence <span style="color: var(--primary);">E-Commerce</span></h1>
        <p class="lead mb-5 opacity-75">Platform Analisis Spasial Strategis untuk Pemetaan Penjualan Nasional</p>
        <button class="btn btn-glow" onclick="initDashboard()">Kunjungi Dashboard</button>
    </div>
</div>

<div id="main-content">
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <span class="navbar-brand fw-bold text-primary">SIG-ECOM</span>
            <ul class="nav nav-pills" id="pills-tab">
                <li class="nav-item"><a class="nav-link active" id="tab-peta" onclick="showTab('peta')">üìç Peta</a></li>
                <li class="nav-item"><a class="nav-link" id="tab-grafik" onclick="showTab('grafik')">üìä Statistik</a></li>
                <li class="nav-item"><a class="nav-link" id="tab-potensial" onclick="showTab('potensial')">üöÄ Potensi</a></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="icon-box bg-primary-subtle text-primary">üì¶</div>
                    <div class="text-secondary small fw-bold text-uppercase">Total Transaksi</div>
                    <h3 id="stat-total" class="fw-bold m-0 text-dark">Rp 0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="icon-box bg-success-subtle text-success">üìà</div>
                    <div class="text-secondary small fw-bold text-uppercase">Rata-rata Wilayah</div>
                    <h3 id="stat-avg" class="fw-bold m-0 text-dark">Rp 0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card p-4">
                    <div class="icon-box bg-warning-subtle text-warning">üìç</div>
                    <div class="text-secondary small fw-bold text-uppercase">Cakupan Wilayah</div>
                    <h3 id="stat-count" class="fw-bold m-0 text-dark">0 Titik</h3>
                </div>
            </div>
        </div>

        <div id="peta-section" class="tab-page">
            <div class="stat-card p-2">
                <div id="map"></div>
            </div>
        </div>

        <div id="grafik-section" class="tab-page d-none">
            <div class="stat-card p-4">
                <h4 class="fw-bold mb-4">Peringkat Penjualan Per Provinsi (Top 10)</h4>
                <div style="height: 500px;"><canvas id="salesChart"></canvas></div>
            </div>
        </div>

        <div id="potensial-section" class="tab-page d-none">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="stat-card p-4">
                        <h4 class="fw-bold mb-3">Provinsi Potensial</h4>
                        <div id="table-provinsi"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="stat-card p-4">
                        <h4 class="fw-bold mb-3">Kab/Kota Potensial</h4>
                        <div id="table-kabkota"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p class="text-secondary mb-2 small text-uppercase fw-bold">Tim Analis Data</p>
            <h5 class="fw-bold mb-4 text-dark">Rizki Chandra &bull; Damar Wyasa Seta &bull; Rizal Fauzan Rosyadi</h5>
            <p class="text-secondary small">&copy; 2025 E-Commerce Spatial Intelligence. All Rights Reserved.</p>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function initDashboard() {
        document.getElementById('welcome-page').style.opacity = '0';
        document.getElementById('welcome-page').style.transform = 'scale(1.1)';
        setTimeout(() => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            setTimeout(() => document.getElementById('main-content').style.opacity = '1', 50);
            map.invalidateSize();
        }, 800);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-page').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName + '-section').classList.remove('d-none');
        document.getElementById('tab-' + tabName).classList.add('active');
        if(tabName === 'peta') map.invalidateSize();
    }

    // Peta Setup
    var map = L.map('map', {zoomControl: false}).setView([-2.5, 118], 5);
    L.control.zoom({position: 'topright'}).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    function getColor(d) {
        return d > 10000000 ? '#1e3a8a' : d > 5000000 ? '#1d4ed8' : 
               d > 1000000 ? '#3b82f6' : d > 500000 ? '#93c5fd' : '#dbeafe';
    }

    let statsProv = {}, rawData = [];

    // Baca Data CSV
    Papa.parse("ecommerce_kabkota_centroid.csv", {
        download: true, header: true,
        complete: function(res) {
            let totalSales = 0, count = 0;
            rawData = res.data.filter(r => r.total_pembayaran && r.lat);
            
            rawData.forEach(row => {
                const val = parseFloat(row.total_pembayaran);
                const prov = row.PROVINSI;
                totalSales += val; count++;
                statsProv[prov] = (statsProv[prov] || 0) + val;

                // UKURAN LINGKARAN DIPERKECIL: 0.008 + 3
                L.circleMarker([row.lat, row.lon], {
                    radius: Math.sqrt(val) * 0.008 + 3,
                    fillColor: getColor(val), color: "white", weight: 1, fillOpacity: 0.8
                }).bindPopup(`<div class="p-1"><strong>${row.KAB_KOTA}</strong><br><span class="text-primary">Rp ${val.toLocaleString('id-ID')}</span></div>`).addTo(map);
            });
            
            // Update Summary Cards
            document.getElementById('stat-total').innerText = 'Rp ' + (totalSales/1000000).toFixed(1) + 'M';
            document.getElementById('stat-avg').innerText = 'Rp ' + (totalSales/count/1000000).toFixed(2) + 'M';
            document.getElementById('stat-count').innerText = count + ' Titik';
            
            renderCharts();
            renderTables();
        }
    });

    // Legend Peta
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        var div = L.DomUtil.create('div', 'legend'), grades = [0, 500000, 1000000, 5000000, 10000000];
        div.innerHTML = '<h6 class="fw-bold mb-2">Skala Penjualan</h6>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                (grades[i]/1000000).toFixed(1) + 'M' + (grades[i+1] ? ' - ' + (grades[i+1]/1000000).toFixed(1) + 'M' : '+') + '<br>';
        }
        return div;
    };
    legend.addTo(map);

    function renderCharts() {
        const labels = Object.keys(statsProv).sort((a,b) => statsProv[b] - statsProv[a]).slice(0, 10);
        new Chart(document.getElementById('salesChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Total Penjualan', data: labels.map(l => statsProv[l]), backgroundColor: '#2563eb', borderRadius: 8 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderTables() {
        const topProv = Object.entries(statsProv).sort((a,b) => b[1] - a[1]).slice(0, 5);
        let h1 = '<table class="table table-hover"><thead><tr><th>Provinsi</th><th>Total</th></tr></thead><tbody>';
        topProv.forEach(p => h1 += `<tr><td>${p[0]}</td><td class="fw-bold">Rp ${(p[1]/1000000).toFixed(1)}M</td></tr>`);
        document.getElementById('table-provinsi').innerHTML = h1 + '</tbody></table>';

        const topKab = rawData.sort((a,b) => b.total_pembayaran - a.total_pembayaran).slice(0, 5);
        let h2 = '<table class="table table-hover"><thead><tr><th>Kota/Kabupaten</th><th>Total</th></tr></thead><tbody>';
        topKab.forEach(k => h2 += `<tr><td>${k.KAB_KOTA}</td><td class="fw-bold text-primary">Rp ${(k.total_pembayaran/1000000).toFixed(1)}M</td></tr>`);
        document.getElementById('table-kabkota').innerHTML = h2 + '</tbody></table>';
    }
</script>
</body>
</html>
